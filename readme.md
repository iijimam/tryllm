# Open source LLMテスト

参考ページ：https://qiita.com/RyutoYoda/items/ecdfbef8c73aae64aa45

使用環境はEC2（Ubuntu22.04）、インスタンスタイプは g4dn.xlarge

## jupyter用に仮想環境設定
### 仮想環境作成
```
python3 -m venv notebook
```
### 仮想環境アクティベート
```
source ./notebook/bin/activate
```
## ollama モデルのダウンロード

- コンテナ開始後、ollamaのコンテナにログインして以下実行
  ```
  docker exec -it ollama bash
  ollama pull gemma
  ollama pull llama3
  ollama pull pakachan/elyza-llama3-8b
  ```

- Web APIも用意があります。

  コンテナネットワーク内なら、ollamaのコンテナ名＝ollama　＋　ポート11434 でアクセスできます。
  ```
  curl http://ollama:11434/api/chat -d '{
    "model": "pakachan/elyza-llama3-8b:latest",
    "messages": [
      { "role": "user", "content": "こんにちは" }
    ],
    "stream":true
  }'
  ```
  > 初回質問時、少し時間かかりますが2回目以降は遅くないです
  
## Web UI

http://localhost:3000/

適当な名称でアカウント登録した後、モデルを左上で選ぶと遅いですがチャットを楽しめます。

モデルによって回答が英語、日本語違います

- llama3

  日本語入力→英語で回答

- gemmaとpakachan/elyza-llama3-8b

  日本語入力→日本語で回答


## IRIS

### 魚検出＋レシピ検索

- 実行するにはIRISコンテナにログイン＋IRISにもログイン

  ```
  docker exec -it iriscontainer1 bash
  iris session iris
  ```

- ベクトル入りテーブル準備

  画像ファイルと一致するテキストをベクトル検索で取り出すためのテーブルを作成。
  
  サンプルデータ：[fish_clip_vectors.jsonl](/iris/data/fish_clip_vectors.jsonl) を [FishDetector.Fish](/iris/src/FishDetector/Fish.cls) にロードする。

  >textのベクトルがembeddingに入っている。

  入力ファイルは、**/data/fish_clip_vectors.jsonl** にある想定で実行してます。[iris/data](/iris/data/)に配置すると、コンテナ内 **/data** に配置されます。
  ```
  do ##class(FishDetector.Fish).loaddata()
  ```

- 実行手順（テスト用）

  - 第1引数：検索したい画像ファイル（[iris/data](/iris/data/)に配置するとコンテナ内 **/data** に配置されるので、**/data/xxx.jpg** で指定できます。）

  - 第2引数：欲しいレシピの情報を入力
  
  ```
  do ##class(FishDetector.Utils).test("/data/aji.jpg","作成時間30分未満でイタリアンのレシピを教えてください。説明動画があればそのURLも教えてください")
  ```
  
  実行結果は以下の通り
  ```
  USER>d ##class(FishDetector.Utils).test("/data/masaba.jpg","作成時間が30分未満のイタリアンのレシピを希望します。")
  ★★ 画像のベクトル化の時間：2.5175440311431885
  ['サバ', '旬は秋〜冬です。調理法としては味噌煮、しめ鯖、塩焼きがあり、味は脂がのっていて濃厚。相性の良い食材は味噌、生姜、大根です。郷土料理にはサバの味噌煮（全国）、しめ鯖（関東・関西）があり、中型〜大型：煮物や焼き物などの調理法がサイズによって使い分けられます。', '.41681322639813356278', '旬は秋〜冬です。調理法としては味噌煮、しめ鯖、塩焼きがあり、味は脂がのっていて濃厚。相性の良い食材は味噌、生姜、大根です。郷土料理にはサバの味噌煮（全国）、しめ鯖（関東・関西）があり、中型〜大型：煮物や焼き物などの調理法がサイズによって使い分けられます。']
  ★★ ベクトル検索だけの処理時間：0.0010743141174316406

  画像の魚は サバ です。

  ★ システムプロンプト：この魚は、旬は秋〜冬です。調理法としては味噌煮、しめ鯖、塩焼きがあり、味は脂がのっていて濃厚。相性の良い食材は味噌、生姜、大根です。郷土料理にはサバの味噌煮（全国）、しめ鯖（関東・関西）があり、中型〜大型：煮物や焼き物などの調理法がサイズによって使い分けられます。 3つのレシピ候補とそれぞれの作り方を分かりやすく解説してください。

  ★ ユーザプロンプト：作成時間が30分未満のイタリアンのレシピを希望します。　
  ***この情報でLLMに質問します***
  処理時間：13.378297567367554

  *****戻ってきた答え*****
  サバはイタリアンにも合います！以下、3つのサバを使ったイタリアンのレシピをご提案します。各々の調理時間は20-25分で、30分未満です。
  レシピ候補1: サバのアクアパッツァ
  ----------------------------------------
  調理時間：15分
  * 材料：
          + サバ中型（2尾）
          + 白ワイン（100ml）
          + 水（50ml）
          + オリーブオイル（20g）
          + ニンニクみじん切り（1片）
          + 刻んだパセリ（適量）
  作り方：フライパンにオリーブオイルを熱し、サバを入れて両面を焼く。白ワインと水を加え、沸騰させてからニンニクを加える。パセリをトッピングして完成。
  レシピ候補2: サバのカプレーゼ
  ----------------------------------------
  調理時間：20分
  * 材料：
          + サバ中型（1尾）
          + トマトソース（100ml）
          + フレッシュモッツァレラチーズ（50g）
          + 刻んだバジル（適量）
  作り方：サバを塩焼きし、トマトソースとモッツァレラチーズを上に乗せる。バジルをトッピングして完成。
  レシピ候補3: サバのジェノベーゼ風リゾット
  ----------------------------------------
  調理時間：25分
  * 材料：
          + サバ小型（2尾）
          + 玄米リゾット（150g）
          + バター（20g）
          + フレッシュパセリ（適量）
          + 作り置きのジェノベーゼソース（大さじ2）
  作り方：サバを塩焼きし、リゾットとジェノベーゼソースを混ぜる。バターを加えて全体に絡め、パセリをトッピングして完成。
  イタリアンのレシピでした！

  全体の処理時間：15.897971630096436

  USER>d ##class(FishDetector.Utils).test("/data/karei.jpg","作成時間が30分未満のイタリアンのレシピを希望します。")
  ★★ 画像のベクトル化の時間：2.5231285095214844
  ['カレイ', '旬は冬です。調理法としては煮付け、唐揚げがあり、味は淡白で繊細な味。相性の良い食材は醤油、みりん、生姜です。郷土料理にはカレイの煮付け（東北）があり、小型：唐揚げ、大型：煮付けなどの調理法がサイズによって使い分けられます。', '.43114010713845840606', '旬は冬です。調理法としては煮付け、唐揚げがあり、味は淡白で繊細な味。相性の良い食材は醤油、みりん、生姜です。郷土料理にはカレイの煮付け（東北）があり、小型：唐揚げ、大型：煮付けなどの調理法がサイズによって使い分けられます。']
  ★★ ベクトル検索だけの処理時間：0.0010166168212890625

  画像の魚は カレイ です。

  ★ システムプロンプト：この魚は、旬は冬です。調理法としては煮付け、唐揚げがあり、味は淡白で繊細な味。相性の良い食材は醤油、みりん、生姜です。郷土料理にはカレイの煮付け（東北）があり、小型：唐揚げ、大型：煮付けなどの調理法がサイズによって使い分けられます。 3つのレシピ候補とそれぞれの作り方を分かりやすく解説してください。

  ★ ユーザプロンプト：作成時間が30分未満のイタリアンのレシピを希望します。　
  ***この情報でLLMに質問します***
  処理時間：19.447757720947266

  *****戻ってきた答え*****
  旬のカレイを使った美味しいイタリアン料理を作りましょう。以下は、30分未満で完成する簡単なレシピです。
  レシピ候補1: カレイのLemon-Herb Fritters
  作成時間: 15分
  材料:
  * 小型カレイ4尾
  * 1/2 cup all-purpose flour
  * 1/4 cup grated Parmesan cheese
  * 1 egg
  * 1/2 lemon, juiced
  * 2 tbsp olive oil
  * Salt and pepper to taste
  * Fresh parsley, chopped (optional)
  作り方:
  1. カレイの皮を除き、身を細かく割る。
  2. ボウルに小麦粉、パルメザンチーズ、卵、レモン汁、塩、胡椒を混ぜておく。
  3. 小型カレイをボウルに加え、全体が衣で覆われるようにして混ぜる。
  4. フライパンにオリーブオイルを熱し、カレイの衣をまとわせた身を入れる。
  5. フリッター状に揚げる。約3-4分。
  6. 上記工程を繰り返し、全てのカレイが揚がったら完成。
  レシピ候補2: カレイと白菜のAglio-E-Olive
  作成時間: 18分
  材料:
  * 中型カレイ2尾
  * 1 medium white cabbage, thinly sliced
  * 3 cloves garlic, minced
  * 1/4 cup olive oil
  * Salt to taste
  * Grated Parmesan cheese (optional)
  作り方:
  1. カレイの皮を除き、身を小さく切る。
  2. フライパンにオリーブオイルを熱し、カレイをソテーする。
  3. 白菜とニンニクを加え、白菜がしんなりするまで炒める。
  4. 塩で味を整える。
  5. カレイを皿に移し、上に白菜のソテーを盛る。
  6. パルメザンチーズを散らすと美味しい。
  レシピ候補3: カレイとTomato's Bruschetta
  作成時間: 12分
  材料:
  * 大型カレイ1尾
  * 2 medium tomatoes, diced
  * 1/4 cup fresh basil, chopped
  * 2 tbsp olive oil
  * 2 cloves garlic, minced
  * Salt to taste
  * Grated Parmesan cheese (optional)
  作り方:
  1. カレイの皮を除き、身を小さく切る。
  2. トマトをボウルに加え、カレイもそこに加える。
  3. オリーブオイルとニンニクを加え、全体が馴染むまで混ぜる。
  4. ブレッドを焼き、上記のカレイとトマトの混合物を載せる。
  5. パルメザンチーズを散らす。
  以上のレシピで、美味しいイタリアン料理を作ってみてください。

  全体の処理時間：21.973005056381226

  USER>
  ```


### テストに使った内容
IRISのUSERネームスペースにTest.Personテーブルを用意し、50件の適当なデータを入れています。

（[person.csv](/iris/data/persons.csv)をビルド時にインポートしてます）

ollamaにTest.Personからとった情報をプロンプトに追加して質問するは、以下メソッドで試せます。

> AskOllamaの第1引数に指定する文字列を含む名前のPersonを検索し、年齢を取得してシステムプロンプトに指定します（年齢＋女性）。ユーザプロンプトに第２引数の情報指定して、ollamaにpost して回答を得てます。

```
docker exec -it iriscontainer1 bash
iris session iris
do ##class(Test.Utils).AskOllama("さゆり","一番かかりやすい病気")
```


**実行例（Gemma）**
```
USER>do ##class(Test.Utils).AskOllama("さゆり","一番かかりやすい病気")
システムプロンプト：51歳女性
51歳女性にとって最もかかりやすい病気は、以下の3つです。
* **骨粗鬆症**：年齢と共に骨の密度が低下し、骨がもろくなる病気。
* **心筋炎**：心筋に感染し、心筋の損傷を引き起こす病気。
* **乳腺ガン**：乳腺に悪性細胞が発生し、乳腺に腫れや痛みを引き起こす病気。
これらの病気は、年齢や生活習慣によって発症の頻度や重度合いは異なる場合があります。
処理時間：3.2689976692199707

USER>do ##class(Test.Utils).AskOllama("子","一番かかりやすい病気")
システムプロンプト：16歳女性
16歳女性にとって一番かかりやすい病気は、以下の3つが考えられます。
* **発条**：10歳～20歳頃に見られ、発熱、頭痛、筋肉痛、関節痛などの症状を引き起こす。
* **発汗症（夜間発汗症）：**睡眠中に発汗する症状で、発汗量や頻度によって軽度から重度まで異なる。
* **メンタルヘルスの問題**：10歳～20歳頃に見られ、不安障害、抑鬱症、注意 deficit症など、様々な症状を引き起こす。
これらの病気は、16歳女性にとって最も多く発生する可能性があります。
処理時間：4.018622398376465
```

**実行例（pakachan/elyza-llama3-8b）**
```
USER>do ##class(Test.Utils).AskOllama("さゆり","一番かかりやすい病気")
システムプロンプト：51歳女性
51歳の女性がかかりやすい病気は、以下のようなものがあります。
1.生活習慣病:
        * 高血圧
        * 高脂血症
        * 糖尿病
2.婦人科系の病気:
        * 子宮筋腫や子宮内膜症などの女性特有の疾患
3.心臓病:
        * 狭心症や心筋梗塞などの冠動脈疾患
4.肺炎:
        * 喘息や慢性閉塞性肺疾患(COPD)などが基礎にあることが多い
5.骨粗鬆症:
        * 骨折や椎体圧迫骨折のリスクが高まる
女性は、更年期を迎えるとホルモンの変化に伴い、自律神経失調症や抑うつ状態などを発症する場合があります。加えて、閉経後は骨密度が低下しやすくなるため、注意が必要です。
また、喫煙やストレスの多い生活習慣も病気のリスクを高める要因となります。定期的な健康診断を受け、早期発見・治療に取り組むことが大切です。
処理時間：8.037974834442139

USER>do ##class(Test.Utils).AskOllama("子","一番かかりやすい病気")
システムプロンプト：16歳女性
16歳の女の子がかかりやすい病気は、実際には多くあります。ただし、統計や調査結果を基に、比較的発症率が高いとされるものをいくつか挙げてみます。
1. 過敏性腸症候群 (IBS): 約15%の10代の女性が罹患しています。
2. 乾癬性関節炎: 中高生に多い疾患で、約8%が罹患しているという調査結果もあります。
3. 急性虫垂炎 (盲腸): 学校保健統計調査では、中学生の入院原因の第5位にランクインしています。
4. 単純ヘルペスウイルス感染症: 再発率が高く、約70%が再発するというデータもあります。
5. 帯状疱疹: 40歳以上で多いとされますが、思春期でも発症します。
特に、ストレスや疲労、免疫力の低下などが要因となりやすい病気は以下です。
1. 風邪やインフルエンザなどの感染症
2.胃腸炎や食中毒など、消化器系の疾患
3.アトピー性皮膚炎や湿疹、痒疹など、皮膚科領域の疾患
これは一例でしかありません。病気の発症には多くの要因が絡み合っています。予防や健康維持を心掛けつつ、異常を感じたら早めに医療機関を受診することが大切です。
処理時間：10.672095775604248
```

> gemmaとpakachan/elyza-llama3-8bだと日本語で回答返ってきます。llama3は英語で回答返ります。初回の質問は回答まで時間がかかりますが2回目以降は高速です。
