# Open source LLMテスト

参考ページ：https://qiita.com/RyutoYoda/items/ecdfbef8c73aae64aa45

使用環境はEC2（Ubuntu22.04）、インスタンスタイプは g4dn.xlarge

## ollama モデルのダウンロード

- コンテナ開始後、ollamaのコンテナにログインして以下実行
  ```
  docker exec -it ollama bash
  ollama pull gemma
  ollama pull llama3
  ollama pull pakachan/elyza-llama3-8b
  ```

- Web APIも用意があります。

  コンテナネットワーク内なら、ollamaのコンテナ名＝ollama　＋　ポート11434 でアクセスできます。
  ```
  curl http://ollama:11434/api/chat -d '{
    "model": "pakachan/elyza-llama3-8b:latest",
    "messages": [
      { "role": "user", "content": "こんにちは" }
    ],
    "stream":true
  }'
  ```
  > 初回質問時、少し時間かかりますが2回目以降は遅くないです
  
## Web UI

http://localhost:3000/

適当な名称でアカウント登録した後、モデルを左上で選ぶと遅いですがチャットを楽しめます。

モデルによって回答が英語、日本語違います

- llama3

  日本語入力→英語で回答

- gemmaとpakachan/elyza-llama3-8b

  日本語入力→日本語で回答


## IRIS

IRISのUSERネームスペースにTest.Personテーブルを用意し、50件の適当なデータを入れています。

（[person.csv](/iris/data/persons.csv)をビルド時にインポートしてます）

ollamaにTest.Personからとった情報をプロンプトに追加して質問するは、以下メソッドで試せます。

> AskOllamaの第1引数に指定する文字列を含む名前のPersonを検索し、年齢を取得してシステムプロンプトに指定します（年齢＋女性）。ユーザプロンプトに第２引数の情報指定して、ollamaにpost して回答を得てます。

```
docker exec -it iriscontainer1 bash
iris session iris
do ##class(Test.Utils).AskOllama("さゆり","一番かかりやすい病気")
```


**実行例（Gemma）**
```
USER>do ##class(Test.Utils).AskOllama("さゆり","一番かかりやすい病気")
システムプロンプト：51歳女性
51歳女性にとって最もかかりやすい病気は、以下の3つです。
* **骨粗鬆症**：年齢と共に骨の密度が低下し、骨がもろくなる病気。
* **心筋炎**：心筋に感染し、心筋の損傷を引き起こす病気。
* **乳腺ガン**：乳腺に悪性細胞が発生し、乳腺に腫れや痛みを引き起こす病気。
これらの病気は、年齢や生活習慣によって発症の頻度や重度合いは異なる場合があります。
処理時間：3.2689976692199707

USER>do ##class(Test.Utils).AskOllama("子","一番かかりやすい病気")
システムプロンプト：16歳女性
16歳女性にとって一番かかりやすい病気は、以下の3つが考えられます。
* **発条**：10歳～20歳頃に見られ、発熱、頭痛、筋肉痛、関節痛などの症状を引き起こす。
* **発汗症（夜間発汗症）：**睡眠中に発汗する症状で、発汗量や頻度によって軽度から重度まで異なる。
* **メンタルヘルスの問題**：10歳～20歳頃に見られ、不安障害、抑鬱症、注意 deficit症など、様々な症状を引き起こす。
これらの病気は、16歳女性にとって最も多く発生する可能性があります。
処理時間：4.018622398376465
```

**実行例（pakachan/elyza-llama3-8b）**
```
USER>do ##class(Test.Utils).AskOllama("さゆり","一番かかりやすい病気")
システムプロンプト：51歳女性
51歳の女性がかかりやすい病気は、以下のようなものがあります。
1.生活習慣病:
        * 高血圧
        * 高脂血症
        * 糖尿病
2.婦人科系の病気:
        * 子宮筋腫や子宮内膜症などの女性特有の疾患
3.心臓病:
        * 狭心症や心筋梗塞などの冠動脈疾患
4.肺炎:
        * 喘息や慢性閉塞性肺疾患(COPD)などが基礎にあることが多い
5.骨粗鬆症:
        * 骨折や椎体圧迫骨折のリスクが高まる
女性は、更年期を迎えるとホルモンの変化に伴い、自律神経失調症や抑うつ状態などを発症する場合があります。加えて、閉経後は骨密度が低下しやすくなるため、注意が必要です。
また、喫煙やストレスの多い生活習慣も病気のリスクを高める要因となります。定期的な健康診断を受け、早期発見・治療に取り組むことが大切です。
処理時間：8.037974834442139

USER>do ##class(Test.Utils).AskOllama("子","一番かかりやすい病気")
システムプロンプト：16歳女性
16歳の女の子がかかりやすい病気は、実際には多くあります。ただし、統計や調査結果を基に、比較的発症率が高いとされるものをいくつか挙げてみます。
1. 過敏性腸症候群 (IBS): 約15%の10代の女性が罹患しています。
2. 乾癬性関節炎: 中高生に多い疾患で、約8%が罹患しているという調査結果もあります。
3. 急性虫垂炎 (盲腸): 学校保健統計調査では、中学生の入院原因の第5位にランクインしています。
4. 単純ヘルペスウイルス感染症: 再発率が高く、約70%が再発するというデータもあります。
5. 帯状疱疹: 40歳以上で多いとされますが、思春期でも発症します。
特に、ストレスや疲労、免疫力の低下などが要因となりやすい病気は以下です。
1. 風邪やインフルエンザなどの感染症
2.胃腸炎や食中毒など、消化器系の疾患
3.アトピー性皮膚炎や湿疹、痒疹など、皮膚科領域の疾患
これは一例でしかありません。病気の発症には多くの要因が絡み合っています。予防や健康維持を心掛けつつ、異常を感じたら早めに医療機関を受診することが大切です。
処理時間：10.672095775604248
```

> gemmaとpakachan/elyza-llama3-8bだと日本語で回答返ってきます。llama3は英語で回答返ります。初回の質問は回答まで時間がかかりますが2回目以降は高速です。
