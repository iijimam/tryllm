# Open source LLMテスト

参考ページ：https://qiita.com/RyutoYoda/items/ecdfbef8c73aae64aa45

使用環境はEC2（Ubuntu22.04）、インスタンスタイプは g4dn.xlarge

## ollama モデルのダウンロード

- コンテナ開始後、ollamaのコンテナにログインして以下実行
  ```
  docker exec -it ollama bash
  ollama pull gemma
  ollama pull llama3
  ```

- Web APIも用意があります。

  コンテナネットワーク内なら、ollamaのコンテナ名＝ollama　＋　ポート11434 でアクセスできます。
  ```
  curl http://ollama:11434/api/chat -d '{
    "model": "gemma",
    "messages": [
      { "role": "user", "content": "こんにちは" }
    ],
    "stream":true
  }'
  ```
  > 初回質問時、少し時間かかりますが2回目以降は遅くないです
  
## Web UI

http://localhost:3000/

適当な名称でアカウント登録した後、モデルを左上で選ぶと遅いですがチャットを楽しめます。（日本語で質問しても理解してくれますが回答は英語です）

## IRIS

IRISのUSERネームスペースにTest.Personテーブルを用意し、50件の適当なデータを入れています。

（[person.csv](/iris/data/persons.csv)をビルド時にインポートしてます）

ollamaにTest.Personからとった情報をプロンプトに追加して質問するは、以下メソッドで試せます。

> AskOllamaの第1引数に指定する文字列を含む名前のPersonを検索し、年齢を取得してシステムプロンプトに指定します（年齢＋女性）。ユーザプロンプトに第２引数の情報指定して、ollamaにpost して回答を得てます。

```
docker exec -it iriscontainer1 bash
iris session iris
do ##class(Test.Utils).AskOllama("さゆり","一番かかりやすい病気")
```

実行例
```
USER>do ##class(Test.Utils).AskOllama("さゆり","一番かかりやすい病気")
システムプロンプト：51歳女性
51歳女性にとって最もかかりやすい病気は、以下の3つです。
* **骨粗鬆症**：年齢と共に骨の密度が低下し、骨がもろくなる病気。
* **心筋炎**：心筋に感染し、心筋の損傷を引き起こす病気。
* **乳腺ガン**：乳腺に悪性細胞が発生し、乳腺に腫れや痛みを引き起こす病気。
これらの病気は、年齢や生活習慣によって発症の頻度や重度合いは異なる場合があります。
処理時間：3.2689976692199707

USER>do ##class(Test.Utils).AskOllama("子","一番かかりやすい病気")
システムプロンプト：16歳女性
16歳女性にとって一番かかりやすい病気は、以下の3つが考えられます。
* **発条**：10歳～20歳頃に見られ、発熱、頭痛、筋肉痛、関節痛などの症状を引き起こす。
* **発汗症（夜間発汗症）：**睡眠中に発汗する症状で、発汗量や頻度によって軽度から重度まで異なる。
* **メンタルヘルスの問題**：10歳～20歳頃に見られ、不安障害、抑鬱症、注意 deficit症など、様々な症状を引き起こす。
これらの病気は、16歳女性にとって最も多く発生する可能性があります。
処理時間：4.018622398376465
```

> gemmaだと日本語で回答返ってきます。llama3は英語で回答返ります。初回の質問は回答まで時間がかかりますが2回目以降は高速です。
